(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,53674,(e,t,r)=>{t.exports=e.r(36518)},67879,e=>{"use strict";async function t(e){try{let t=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),r=await t.json();return r.success&&localStorage.setItem("auth_token",e),r}catch(e){throw console.error("Login error:",e),e}}function r(){let e=localStorage.getItem("auth_token"),t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t}async function a(e=0,t=20){try{let a=await fetch(`/api/random-image?offset=${e}&limit=${t}`,{method:"GET",headers:r()});if(!a.ok){if(401===a.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${a.status}`)}let i=await a.json();if(!i.success||!i.data)throw Error("API request failed");return i.data.map(e=>({id:e.image_id,src:e.img_webp?c(e.img_webp):"",category:e.category,description:e.description,create_time:e.create_time,real_src:e.image_path?c(e.image_path):""}))}catch(e){throw console.error("Error fetching images:",e),e}}async function i(e,t=0,a=20){try{let i=await fetch(`/api/search?keyword=${encodeURIComponent(e)}&offset=${t}&limit=${a}`,{method:"GET",headers:r()});if(!i.ok){if(401===i.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${i.status}`)}let o=await i.json();if(!o.success||!o.data)throw Error("API request failed");return o.data.map(e=>({id:e.image_id,src:e.img_webp?c(e.img_webp):"",category:e.category,description:e.description,create_time:e.create_time,real_src:e.image_path?c(e.image_path):""}))}catch(e){throw console.error("Error searching images:",e),e}}async function o(e){try{let t=await fetch("/api/describe-image",{method:"POST",headers:r(),body:JSON.stringify({image_id:e})});if(!t.ok){if(401===t.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${t.status}`)}let a=await t.json();if(!a.success)throw Error("API request failed");return a.data}catch(e){throw console.error("Error describing image:",e),e}}async function s(e){try{let t=await fetch(`/api/delete_image/${e}`,{method:"DELETE",headers:r()});if(!t.ok){if(401===t.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${t.status}`)}let a=await t.json();if(!a.success)throw Error(a.message||"Failed to delete image")}catch(e){throw console.error("Error deleting image:",e),e}}async function n(e=0,t=20){try{let a=await fetch(`/api/images_by_time?offset=${e}&limit=${t}`,{method:"GET",headers:r()});if(!a.ok){if(401===a.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${a.status}`)}let i=await a.json();if(!i.success||!i.data)throw Error("API request failed");return i.data.map(e=>({id:e.image_id,src:e.img_webp?c(e.img_webp):"",category:e.category,description:e.description,create_time:e.create_time,real_src:e.image_path?c(e.image_path):""}))}catch(e){throw console.error("Error fetching images by time:",e),e}}function c(e){return`/${e.replace(/\\/g,"/")}`}e.i(35939),e.s(["deleteImage",()=>s,"describeImage",()=>o,"fetchImagesByTime",()=>n,"fetchRandomImages",()=>a,"login",()=>t,"searchImages",()=>i],67879)},5860,e=>{"use strict";var t=e.i(52608),r=e.i(43942),a=e.i(53674),i=e.i(35683),o=e.i(95323),s=e.i(93768),n=e.i(67879),c=e.i(60885);function l(){let e=(0,a.useRouter)(),{showLoading:l,hideLoading:u,showLoadingWithProgress:d,updateProgress:m}=(0,c.useLoading)(),[h,g]=(0,r.useState)(null),[f,w]=(0,r.useState)([]),[p,y]=(0,r.useState)(!1),[b,x]=(0,r.useState)(null),[_,E]=(0,r.useState)(!0),[T,j]=(0,r.useState)(!1),I=(0,r.useRef)(null),S=(0,r.useRef)(0),$=(0,r.useRef)(!1),v=(0,r.useRef)(!1),N=(0,r.useRef)(new Set),P=(0,r.useRef)(!1),[R,k]=(0,r.useState)(!1),A=async()=>{if(!$.current){$.current=!0,N.current.clear(),P.current=!1;try{d("加载中..."),x(null),m(20);let e=await (0,n.fetchRandomImages)(0,20);m(60),w(e),S.current=20,E(e.length>=20),P.current=!0,0===e.length&&(m(100),setTimeout(()=>{u()},300),$.current=!1)}catch(e){x("加载图片失败，请稍后重试"),console.error("Failed to load images:",e),u(),$.current=!1}}},C=async()=>{if(!p&&_&&!$.current){$.current=!0;try{y(!0);let e=await (R?(0,n.fetchRandomImages)(S.current,20):(0,n.fetchImagesByTime)(S.current,20));w(t=>{let r=new Set(t.map(e=>e.id)),a=e.filter(e=>!r.has(e.id));return[...t,...a]}),S.current+=20,E(e.length>=20)}catch(e){console.error("Failed to load more images:",e)}finally{y(!1),$.current=!1}}};return((0,r.useEffect)(()=>{v.current||((v.current=!0,localStorage.getItem("auth_token"))?(j(!0),A()):e.push("/login"))},[e]),(0,r.useEffect)(()=>{if(!T)return;let e=new IntersectionObserver(e=>{e[0].isIntersecting&&_&&!p&&C()},{threshold:.01,rootMargin:"200px"});return I.current&&e.observe(I.current),()=>{I.current&&e.unobserve(I.current)}},[T,_,p]),b)?(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:(0,t.jsxs)("div",{className:"text-center max-w-md",children:[(0,t.jsx)("div",{className:"text-red-500 text-6xl mb-4",children:"⚠️"}),(0,t.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:"加载失败"}),(0,t.jsx)("p",{className:"text-gray-600 mb-6",children:b}),(0,t.jsx)("button",{onClick:A,className:"bg-black text-white px-6 py-3 rounded-xl font-semibold hover:bg-gray-800 transition",children:"重新加载"})]})}):T?(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50 p-4 md:p-8",children:[(0,t.jsx)(i.Header,{}),(0,t.jsx)(o.GalleryGrid,{items:f,onItemClick:e=>g(e),onImageLoaded:e=>{N.current.add(e);let t=Date.now(),r=()=>{let e=Math.min((Date.now()-t)/3e3*100,100);m(e),e<100&&requestAnimationFrame(r)};requestAnimationFrame(r),setTimeout(()=>{u(),$.current=!1},300)},currentClass:R}),p&&(0,t.jsx)("div",{className:"flex justify-center py-8",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}),!_&&f.length>0&&(0,t.jsx)("div",{className:"text-center py-8 text-gray-500",children:"没有更多图片了"}),(0,t.jsx)("div",{ref:I,className:"h-20"}),(0,t.jsx)(s.ImageModal,{selectedItem:h,onClose:()=>g(null),onDescriptionUpdate:(e,t)=>{w(r=>r.map(r=>r.id===e?{...r,description:t}:r)),h&&h.id===e&&g(e=>e?{...e,description:t}:null)},onDelete:e=>{w(t=>t.filter(t=>t.id!==e))}})]}):null}e.s(["default",()=>l])}]);