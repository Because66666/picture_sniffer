(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,53674,(e,r,t)=>{r.exports=e.r(36518)},67879,e=>{"use strict";async function r(e){try{let r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),t=await r.json();return t.success&&localStorage.setItem("auth_token",e),t}catch(e){throw console.error("Login error:",e),e}}function t(){let e=localStorage.getItem("auth_token"),r={"Content-Type":"application/json"};return e&&(r.Authorization=`Bearer ${e}`),r}async function a(e=0,r=20){try{let a=await fetch(`/api/random-image?offset=${e}&limit=${r}`,{method:"GET",headers:t()});if(!a.ok){if(401===a.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${a.status}`)}let o=await a.json();if(!o.success||!o.data)throw Error("API request failed");return o.data.map(e=>({id:e.image_id,src:s(e.image_path),category:e.category,description:e.description}))}catch(e){throw console.error("Error fetching images:",e),e}}async function o(e,r=0,a=20){try{let o=await fetch(`/api/search?keyword=${encodeURIComponent(e)}&offset=${r}&limit=${a}`,{method:"GET",headers:t()});if(!o.ok){if(401===o.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${o.status}`)}let n=await o.json();if(!n.success||!n.data)throw Error("API request failed");return n.data.map(e=>({id:e.image_id,src:s(e.image_path),category:e.category,description:e.description}))}catch(e){throw console.error("Error searching images:",e),e}}async function n(e){try{let r=await fetch("/api/describe-image",{method:"POST",headers:t(),body:JSON.stringify({image_id:e})});if(!r.ok){if(401===r.status)throw window.location.href="/login",Error("Unauthorized");throw Error(`HTTP error! status: ${r.status}`)}let a=await r.json();if(!a.success)throw Error("API request failed");return a.data}catch(e){throw console.error("Error describing image:",e),e}}function s(e){return`/${e.replace(/\\/g,"/")}`}e.i(35939),e.s(["describeImage",()=>n,"fetchRandomImages",()=>a,"login",()=>r,"searchImages",()=>o],67879)},5860,e=>{"use strict";var r=e.i(52608),t=e.i(43942),a=e.i(53674),o=e.i(35683),n=e.i(95323),s=e.i(93768),i=e.i(67879),c=e.i(60885);function l(){let e=(0,a.useRouter)(),{showLoading:l,hideLoading:u,showLoadingWithProgress:d,updateProgress:h}=(0,c.useLoading)(),[m,f]=(0,t.useState)(null),[g,p]=(0,t.useState)([]),[w,y]=(0,t.useState)(!1),[x,b]=(0,t.useState)(null),[j,I]=(0,t.useState)(!0),[T,E]=(0,t.useState)(!1),S=(0,t.useRef)(null),v=(0,t.useRef)(0),N=(0,t.useRef)(!1),R=(0,t.useRef)(!1),k=(0,t.useRef)(new Set),P=(0,t.useRef)(!1),$=async()=>{if(!N.current){N.current=!0,k.current.clear(),P.current=!1;try{d("加载中..."),b(null),h(20);let e=await (0,i.fetchRandomImages)(0,20);h(60),p(e),v.current=20,I(e.length>=20),P.current=!0,0===e.length&&(h(100),setTimeout(()=>{u()},300),N.current=!1)}catch(e){b("加载图片失败，请稍后重试"),console.error("Failed to load images:",e),u(),N.current=!1}}},A=async()=>{if(!w&&j&&!N.current){N.current=!0;try{y(!0);let e=await (0,i.fetchRandomImages)(v.current,20);p(r=>{let t=new Set(r.map(e=>e.id)),a=e.filter(e=>!t.has(e.id));return[...r,...a]}),v.current+=20,I(e.length>=20)}catch(e){console.error("Failed to load more images:",e)}finally{y(!1),N.current=!1}}};return((0,t.useEffect)(()=>{R.current||((R.current=!0,localStorage.getItem("auth_token"))?(E(!0),$()):e.push("/login"))},[e]),(0,t.useEffect)(()=>{if(!T)return;let e=new IntersectionObserver(e=>{e[0].isIntersecting&&j&&!w&&A()},{threshold:.01,rootMargin:"200px"});return S.current&&e.observe(S.current),()=>{S.current&&e.unobserve(S.current)}},[T,j,w]),x)?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:(0,r.jsxs)("div",{className:"text-center max-w-md",children:[(0,r.jsx)("div",{className:"text-red-500 text-6xl mb-4",children:"⚠️"}),(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:"加载失败"}),(0,r.jsx)("p",{className:"text-gray-600 mb-6",children:x}),(0,r.jsx)("button",{onClick:$,className:"bg-black text-white px-6 py-3 rounded-xl font-semibold hover:bg-gray-800 transition",children:"重新加载"})]})}):T?(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50 p-4 md:p-8",children:[(0,r.jsx)(o.Header,{}),(0,r.jsx)(n.GalleryGrid,{items:g,onItemClick:e=>f(e),onImageLoaded:e=>{k.current.add(e);let r=Date.now(),t=()=>{let e=Math.min((Date.now()-r)/3e3*100,100);h(e),e<100&&requestAnimationFrame(t)};requestAnimationFrame(t),setTimeout(()=>{u(),N.current=!1},300)}}),w&&(0,r.jsx)("div",{className:"flex justify-center py-8",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}),!j&&g.length>0&&(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:"没有更多图片了"}),(0,r.jsx)("div",{ref:S,className:"h-20"}),(0,r.jsx)(s.ImageModal,{selectedItem:m,onClose:()=>f(null),onDescriptionUpdate:(e,r)=>{p(t=>t.map(t=>t.id===e?{...t,description:r}:t)),m&&m.id===e&&f(e=>e?{...e,description:r}:null)}})]}):null}e.s(["default",()=>l])}]);